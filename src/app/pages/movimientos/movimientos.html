<div class="movimientos-container">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>
  
  <!-- Header Section -->
  <div class="page-header">
    <h1>Movimientos de Inventario</h1>
    <p>Gestión de entradas y salidas de productos</p>
  </div>

  <!-- Main Content Card -->
  <p-card styleClass="main-card">
    
    <!-- Toolbar Mejorado con SplitButtons -->
    <div class="simple-toolbar">
      <div class="toolbar-row">
        <!-- Movimientos Principales -->
        <p-splitButton 
          label="Nuevo Movimiento" 
          icon="pi pi-plus"
          severity="primary"
          class="main-split-btn"
          (onClick)="openEntradaDialog()"
          [model]="movimientosMenuItems">
        </p-splitButton>
        
        <!-- Operaciones Avanzadas -->
        <p-splitButton 
          label="Operaciones" 
          icon="pi pi-cog"
          severity="secondary"
          class="operations-split-btn"
          (onClick)="openDivisionDialog()"
          [model]="operacionesMenuItems">
        </p-splitButton>
        
        <!-- Consultas y Reportes -->
        <p-splitButton 
          label="Consultas" 
          icon="pi pi-chart-bar"
          severity="info"
          class="reports-split-btn"
          (onClick)="openInventarioDialog()"
          [model]="reportesMenuItems">
        </p-splitButton>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
      <p-card header="Filtros de Búsqueda" styleClass="filters-card">
        <form [formGroup]="filtroForm">
          <div class="filters-grid">
            
            <!-- Tipo Filter -->
            <div class="filter-field">
              <label for="tipo">Tipo de Movimiento</label>
              <p-select 
                id="tipo"
                formControlName="tipo"
                [options]="tipoOptions"
                placeholder="Todos los tipos"
                optionLabel="label"
                optionValue="value">
              </p-select>
            </div>
            
            <!-- Producto Filter -->
            <div class="filter-field">
              <label for="producto">Producto</label>
              <p-select 
                id="producto"
                formControlName="productoId"
                [options]="productos"
                placeholder="Todos los productos"
                optionLabel="descripcion"
                optionValue="id"
                [filter]="true"
                filterBy="descripcion,codigo"
                [showClear]="true">
                <ng-template pTemplate="selectedItem" let-producto>
                  <span *ngIf="producto">{{ producto.codigo }} - {{ producto.descripcion }}</span>
                </ng-template>
                <ng-template pTemplate="item" let-producto>
                  <div class="producto-option">
                    <span class="codigo">{{ producto.codigo }}</span>
                    <span class="descripcion">{{ producto.descripcion }}</span>
                  </div>
                </ng-template>
              </p-select>
            </div>
            
            <!-- Bodega Filter -->
            <div class="filter-field">
              <label for="bodega">Bodega</label>
              <p-select 
                id="bodega"
                formControlName="bodegaId"
                [options]="bodegas"
                placeholder="Todas las bodegas"
                optionLabel="nombre"
                optionValue="id"
                [showClear]="true">
              </p-select>
            </div>
            
            <!-- Cliente Filter -->
            <div class="filter-field">
              <label for="cliente">Cliente</label>
              <p-select 
                id="cliente"
                formControlName="clienteId"
                [options]="clientes"
                placeholder="Todos los clientes"
                optionLabel="nombre"
                optionValue="id"
                [filter]="true"
                filterBy="nombre"
                [showClear]="true">
              </p-select>
            </div>
            
            <!-- Fecha Desde -->
            <div class="filter-field">
              <label for="fechaDesde">Fecha Desde</label>
              <p-datepicker  
                id="fechaDesde"
                formControlName="fechaDesde"
                dateFormat="dd/mm/yy"
                [showIcon]="true"
                iconDisplay="input"
                [showButtonBar]="true">
              </p-datepicker >
            </div>
            
            <!-- Fecha Hasta -->
            <div class="filter-field">
              <label for="fechaHasta">Fecha Hasta</label>
              <p-datepicker  
                id="fechaHasta"
                formControlName="fechaHasta"
                dateFormat="dd/mm/yy"
                [showIcon]="true"
                iconDisplay="input"
                [showButtonBar]="true">
              </p-datepicker >
            </div>
          </div>
          
          <!-- Filter Actions -->
          <div class="filter-actions">
            <p-button 
              type="button"
              icon="pi pi-filter" 
              label="Filtrar" 
              severity="primary"
              (onClick)="onFilter()">
            </p-button>
            
            <p-button 
              type="button"
              icon="pi pi-filter-slash" 
              label="Limpiar" 
              severity="secondary"
              (onClick)="clearFilters()">
            </p-button>
          </div>
        </form>
      </p-card>
    </div>

    <!-- Table -->
    <p-table 
      [value]="movimientos"
      [loading]="loading"
      [paginator]="true"
      [rows]="rows"
      [totalRecords]="totalRecords"
      [lazy]="true"
      (onLazyLoad)="onPageChange($event)"
      [first]="first"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} movimientos"
      [tableStyle]="{'min-width': '80rem'}"
      styleClass="p-datatable-sm">
      
      <!-- Table Header -->
      <ng-template pTemplate="header">
        <tr>
          <th *ngFor="let col of columns" 
              [style.width]="col.width">
            {{ col.header }}
          </th>
          <th style="width: 120px">Acciones</th>
        </tr>
      </ng-template>
      
      <!-- Table Body -->
      <ng-template pTemplate="body" let-movimiento>
        <tr>
          <td>
            <span class="fecha-text">
              {{ formatDate(movimiento.fecha) }}
            </span>
          </td>
          <td>
            <p-tag 
              [value]="movimiento.tipo === 'entrada' ? 'Entrada' : 'Salida'"
              [severity]="getSeverityForTipo(movimiento.tipo)"
              [icon]="movimiento.tipo === 'entrada' ? 'pi pi-arrow-up' : 'pi pi-arrow-down'">
            </p-tag>
          </td>
          <td>
            <span class="codigo-badge">{{ movimiento.producto.codigo }}</span>
          </td>
          <td>
            <div class="producto-cell">
              <strong>{{ movimiento.producto.descripcion }}</strong>
              <small class="unidad-medida">{{ movimiento.producto.unidadMedida.nombre }}</small>
            </div>
          </td>
          <td>
            <span class="bodega-text">{{ movimiento.bodega.nombre }}</span>
            <small class="ubicacion-text" *ngIf="movimiento.bodega.ubicacion">
              {{ movimiento.bodega.ubicacion }}
            </small>
          </td>
          <td>
            <p-tag 
              [value]="movimiento.cantidad.toString()"
              severity="secondary"
              [rounded]="true">
            </p-tag>
          </td>
          <td>
            <span *ngIf="movimiento.cliente">{{ movimiento.cliente.nombre }}</span>
            <span *ngIf="!movimiento.cliente" class="no-client">Sin cliente</span>
          </td>
          <td>
            <span class="usuario-text">{{ movimiento.usuario.nombre }}</span>
          </td>
          <td>
            <div class="action-buttons">
              <p-button 
                icon="pi pi-eye" 
                severity="info"
                size="small"
                pTooltip="Ver detalles"
                tooltipPosition="top">
              </p-button>
              
              <!-- Solo admin puede editar -->
              <p-button 
                *ngIf="canEditMovimientos()"
                icon="pi pi-pencil" 
                severity="secondary"
                size="small"
                pTooltip="Editar movimiento"
                tooltipPosition="top"
                (onClick)="openEditDialog(movimiento)">
              </p-button>
              
              <!-- Solo admin puede eliminar -->
              <p-button 
                *ngIf="canDeleteMovimientos()"
                icon="pi pi-trash" 
                severity="danger"
                size="small"
                pTooltip="Eliminar movimiento"
                tooltipPosition="top"
                (onClick)="confirmDelete(movimiento)">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>
      
      <!-- Empty State -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td [attr.colspan]="columns.length + 1" class="text-center">
            <div class="empty-state">
              <i class="pi pi-history empty-icon"></i>
              <h4>No hay movimientos</h4>
              <p>No se encontraron movimientos con los filtros aplicados</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- Entrada Dialog -->
  <p-dialog 
    [(visible)]="displayEntradaDialog" 
    header="Nueva Entrada de Inventario"
    [modal]="true"
    [style]="{width: '600px'}"
    [closable]="true"
    [draggable]="false"
    [resizable]="false">

    <form [formGroup]="entradaForm" (ngSubmit)="saveEntrada()">
      
      <!-- Producto Field -->
      <div class="form-field">
        <label for="producto-entrada">
          Producto <span class="required">*</span>
        </label>
        <p-select 
          id="producto-entrada"
          formControlName="productoId"
          [options]="productos"
          placeholder="Seleccionar producto"
          optionLabel="descripcion"
          optionValue="id"
          [filter]="true"
          filterBy="descripcion,codigo"
          [class.ng-invalid]="entradaForm.get('productoId')?.invalid && entradaForm.get('productoId')?.touched">
          <ng-template pTemplate="selectedItem" let-producto>
            <span *ngIf="producto">{{ producto.codigo }} - {{ producto.descripcion }}</span>
          </ng-template>
          <ng-template pTemplate="item" let-producto>
            <div class="producto-option">
              <span class="codigo">{{ producto.codigo }}</span>
              <span class="descripcion">{{ producto.descripcion }}</span>
            </div>
          </ng-template>
        </p-select>
        
        <small 
          class="p-error" 
          *ngIf="entradaForm.get('productoId')?.invalid && entradaForm.get('productoId')?.touched">
          Producto es requerido
        </small>
      </div>

      <!-- Bodega Field -->
      <div class="form-field">
        <label for="bodega-entrada">
          Bodega <span class="required">*</span>
        </label>
        <p-select 
          id="bodega-entrada"
          formControlName="bodegaId"
          [options]="bodegas"
          placeholder="Seleccionar bodega"
          optionLabel="nombre"
          optionValue="id"
          [class.ng-invalid]="entradaForm.get('bodegaId')?.invalid && entradaForm.get('bodegaId')?.touched">
        </p-select>
        
        <small 
          class="p-error" 
          *ngIf="entradaForm.get('bodegaId')?.invalid && entradaForm.get('bodegaId')?.touched">
          Bodega es requerida
        </small>
      </div>

      <!-- Cliente Field -->
      <div class="form-field">
        <label for="cliente-entrada">Cliente/Proveedor</label>
        <p-select 
          id="cliente-entrada"
          formControlName="clienteId"
          [options]="clientes"
          placeholder="Seleccionar cliente (opcional)"
          optionLabel="nombre"
          optionValue="id"
          [filter]="true"
          filterBy="nombre"
          [showClear]="true">
        </p-select>
        
        <small class="p-help">
          Cliente o proveedor asociado a la entrada (opcional)
        </small>
      </div>

      <!-- Cantidad Field -->
      <div class="form-field">
        <label for="cantidad-entrada">
          Cantidad <span class="required">*</span>
        </label>
        <p-inputNumber
          id="cantidad-entrada"
          formControlName="cantidad"
          mode="decimal"
          [minFractionDigits]="0"
          [maxFractionDigits]="2"
          [min]="0.01"
          placeholder="0.00"
          [class.ng-invalid]="entradaForm.get('cantidad')?.invalid && entradaForm.get('cantidad')?.touched">
        </p-inputNumber>

        <small
          class="p-error"
          *ngIf="entradaForm.get('cantidad')?.invalid && entradaForm.get('cantidad')?.touched">
          Cantidad debe ser mayor a 0
        </small>
      </div>

      <!-- Precio Field -->
      <div class="form-field">
        <label for="precio-entrada">Precio Unitario</label>
        <p-inputNumber
          id="precio-entrada"
          formControlName="precio"
          mode="currency"
          currency="USD"
          locale="es-ES"
          [minFractionDigits]="2"
          [maxFractionDigits]="2"
          [min]="0"
          placeholder="0.00"
          [class.ng-invalid]="entradaForm.get('precio')?.invalid && entradaForm.get('precio')?.touched">
        </p-inputNumber>

        <small class="p-help">
          Precio unitario del producto en esta entrada (opcional)
        </small>

        <small
          class="p-error"
          *ngIf="entradaForm.get('precio')?.invalid && entradaForm.get('precio')?.touched">
          El precio no puede ser negativo
        </small>
      </div>

      <!-- Observación Field -->
      <div class="form-field">
        <label for="observacion-entrada">Observaciones</label>
        <textarea 
          id="observacion-entrada"
          pTextarea 
          formControlName="observacion"
          placeholder="Notas adicionales sobre la entrada..."
          rows="3"
          [autoResize]="true">
        </textarea>
        
        <small class="p-help">
          Información adicional sobre el movimiento (opcional)
        </small>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <p-button 
          type="button"
          label="Cancelar"
          icon="pi pi-times"
          severity="secondary"
          (click)="displayEntradaDialog = false">
        </p-button>
        
        <p-button 
          type="submit"
          label="Registrar Entrada"
          icon="pi pi-check"
          severity="success"
          [disabled]="entradaForm.invalid">
        </p-button>
      </div>
    </form>
  </p-dialog>

  <!-- Salida Dialog -->
  <p-dialog 
    [(visible)]="displaySalidaDialog" 
    header="Nueva Salida de Inventario"
    [modal]="true"
    [style]="{width: '600px'}"
    [closable]="true"
    [draggable]="false"
    [resizable]="false">

    <form [formGroup]="salidaForm" (ngSubmit)="saveSalida()">
      
      <!-- Producto Field -->
      <div class="form-field">
        <label for="producto-salida">
          Producto <span class="required">*</span>
        </label>
        <p-select 
          id="producto-salida"
          formControlName="productoId"
          [options]="productos"
          placeholder="Seleccionar producto"
          optionLabel="descripcion"
          optionValue="id"
          [filter]="true"
          filterBy="descripcion,codigo"
          [class.ng-invalid]="salidaForm.get('productoId')?.invalid && salidaForm.get('productoId')?.touched">
          <ng-template pTemplate="selectedItem" let-producto>
            <span *ngIf="producto">{{ producto.codigo }} - {{ producto.descripcion }}</span>
          </ng-template>
          <ng-template pTemplate="item" let-producto>
            <div class="producto-option">
              <span class="codigo">{{ producto.codigo }}</span>
              <span class="descripcion">{{ producto.descripcion }}</span>
            </div>
          </ng-template>
        </p-select>
        
        <small 
          class="p-error" 
          *ngIf="salidaForm.get('productoId')?.invalid && salidaForm.get('productoId')?.touched">
          Producto es requerido
        </small>
      </div>

      <!-- Bodega Field -->
      <div class="form-field">
        <label for="bodega-salida">
          Bodega <span class="required">*</span>
        </label>
        <p-select 
          id="bodega-salida"
          formControlName="bodegaId"
          [options]="bodegas"
          placeholder="Seleccionar bodega"
          optionLabel="nombre"
          optionValue="id"
          [class.ng-invalid]="salidaForm.get('bodegaId')?.invalid && salidaForm.get('bodegaId')?.touched">
        </p-select>
        
        <small 
          class="p-error" 
          *ngIf="salidaForm.get('bodegaId')?.invalid && salidaForm.get('bodegaId')?.touched">
          Bodega es requerida
        </small>
      </div>

      <!-- Cliente Field -->
      <div class="form-field">
        <label for="cliente-salida">Cliente</label>
        <p-select 
          id="cliente-salida"
          formControlName="clienteId"
          [options]="clientes"
          placeholder="Seleccionar cliente (opcional)"
          optionLabel="nombre"
          optionValue="id"
          [filter]="true"
          filterBy="nombre"
          [showClear]="true">
        </p-select>
        
        <small class="p-help">
          Cliente asociado a la salida (opcional)
        </small>
      </div>

      <!-- Cantidad Field -->
      <div class="form-field">
        <label for="cantidad-salida">
          Cantidad <span class="required">*</span>
        </label>
        <p-inputNumber 
          id="cantidad-salida"
          formControlName="cantidad"
          mode="decimal"
          [minFractionDigits]="0"
          [maxFractionDigits]="2"
          [min]="0.01"
          placeholder="0.00"
          [class.ng-invalid]="salidaForm.get('cantidad')?.invalid && salidaForm.get('cantidad')?.touched">
        </p-inputNumber>
        
        <small 
          class="p-error" 
          *ngIf="salidaForm.get('cantidad')?.invalid && salidaForm.get('cantidad')?.touched">
          Cantidad debe ser mayor a 0
        </small>
      </div>

      <!-- Observación Field -->
      <div class="form-field">
        <label for="observacion-salida">Observaciones</label>
        <textarea 
          id="observacion-salida"
          pTextarea 
          formControlName="observacion"
          placeholder="Notas adicionales sobre la salida..."
          rows="3"
          [autoResize]="true">
        </textarea>
        
        <small class="p-help">
          Información adicional sobre el movimiento (opcional)
        </small>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <p-button 
          type="button"
          label="Cancelar"
          icon="pi pi-times"
          severity="secondary"
          (click)="displaySalidaDialog = false">
        </p-button>
        
        <p-button 
          type="submit"
          label="Registrar Salida"
          icon="pi pi-check"
          severity="info"
          [disabled]="salidaForm.invalid">
        </p-button>
      </div>
    </form>
  </p-dialog>
</div>


<p-dialog 
  [(visible)]="displayInventarioDialog" 
  header="Inventario General del Sistema"
  [modal]="true"
  [style]="{width: '95vw', maxWidth: '1200px', height: '85vh'}"
  [closable]="true"
  [draggable]="false"
  [resizable]="true"
  styleClass="inventario-dialog">

  <!-- Loading State -->
  <div class="inventario-loading" *ngIf="loadingInventario">
    <div class="loading-content">
      <p-progressSpinner strokeWidth="4" animationDuration="1s"></p-progressSpinner>
      <p>Cargando inventario...</p>
    </div>
  </div>

  <!-- Content -->
  <div class="inventario-content" *ngIf="!loadingInventario && inventarioData">
    
    <!-- Statistics Summary -->
    <div class="inventario-stats">
      <div class="stats-grid">
        <div class="stat-card productos">
          <div class="stat-icon">
            <i class="pi pi-box"></i>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ inventarioData.estadisticas.totalProductosDiferentes }}</span>
            <span class="stat-label">Productos Diferentes</span>
          </div>
        </div>
        
        <div class="stat-card bodegas">
          <div class="stat-icon">
            <i class="pi pi-building"></i>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ inventarioData.estadisticas.totalBodegas }}</span>
            <span class="stat-label">Bodegas Activas</span>
          </div>
        </div>
        
        <div class="stat-card stock">
          <div class="stat-icon">
            <i class="pi pi-database"></i>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ inventarioData.estadisticas.stockTotalUnidades | number:'1.0-2' }}</span>
            <span class="stat-label">Unidades en Stock</span>
          </div>
        </div>
        
        <div class="stat-card alertas">
          <div class="stat-icon">
            <i class="pi pi-exclamation-triangle"></i>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ inventarioData.estadisticas.productosStockBajo }}</span>
            <span class="stat-label">Stock Bajo</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="inventario-filters">
      <p-card header="Filtros" styleClass="filters-card">
        <div class="filters-row">
          <div class="filter-group">
            <label for="bodega-filter">Bodega</label>
            <p-select 
              id="bodega-filter"
              [(ngModel)]="inventarioFiltros.bodegaId"
              [options]="bodegas"
              placeholder="Todas las bodegas"
              optionLabel="nombre"
              optionValue="id"
              [showClear]="true">
            </p-select>
          </div>
          
          <div class="filter-group">
            <label for="stock-filter">Stock Mínimo</label>
            <p-inputNumber 
              id="stock-filter"
              [(ngModel)]="inventarioFiltros.stockMinimo"
              [min]="0"
              placeholder="Cualquier cantidad">
            </p-inputNumber>
          </div>
          
          <div class="filter-group checkbox-group">
            <p-checkbox 
              [(ngModel)]="inventarioFiltros.soloStockBajo"
              binary="true"
              inputId="stock-bajo">
            </p-checkbox>
            <label for="stock-bajo">Solo stock bajo (≤10)</label>
          </div>
          
          <div class="filter-actions">
            <p-button 
              icon="pi pi-filter" 
              label="Filtrar"
              severity="primary"
              (onClick)="onFiltrarInventario()">
            </p-button>
            
            <p-button 
              icon="pi pi-filter-slash" 
              label="Limpiar"
              severity="secondary"
              (onClick)="clearInventarioFilters()">
            </p-button>
          </div>
        </div>
      </p-card>
    </div>

    <!-- Tabs -->
<p-tabs value="detallado" styleClass="inventario-tabs">
  <p-tablist>
    <p-tab value="detallado">
      <i class="pi pi-list"></i>
      <span>Inventario Detallado</span>
    </p-tab>
    <p-tab value="productos">
      <i class="pi pi-box"></i>
      <span>Por Producto</span>
    </p-tab>
    <p-tab value="bodegas">
      <i class="pi pi-building"></i>
      <span>Por Bodega</span>
    </p-tab>
  </p-tablist>

  <p-tabpanels>
    <!-- Tab 1: Detalle por Producto-Bodega -->
    <p-tabpanel value="detallado">
      <div class="tab-content">
        <p-table 
          [value]="inventarioData.inventario"
          [paginator]="true"
          [rows]="15"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
          [tableStyle]="{'min-width': '100%'}"
          styleClass="inventario-table"
          [scrollable]="true"
          scrollHeight="400px">

          <ng-template pTemplate="header">
            <tr>
              <th>Código</th>
              <th>Producto</th>
              <th>Bodega</th>
              <th>Stock</th>
              <th>Movimientos</th>
              <th>Último Movimiento</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-item>
            <tr>
              <td>
                <span class="codigo-producto">{{ item?.producto?.codigo || 'N/A' }}</span>
              </td>
              <td>
                <div class="producto-info">
                  <strong>{{ item?.producto?.descripcion || 'Sin descripción' }}</strong>
                  <small class="unidad">{{ item?.producto?.unidadMedida || 'N/A' }}</small>
                </div>
              </td>
              <td>
                <div class="bodega-info">
                  <span class="nombre">{{ item?.bodega?.nombre || 'Sin nombre' }}</span>
                  @if (item?.bodega?.ubicacion) {
                    <small class="ubicacion">{{ item.bodega.ubicacion }}</small>
                  }
                </div>
              </td>
              <td>
                <p-tag 
                  [value]="formatNumber(item?.stock)"
                  [severity]="getStockSeverity(item?.stock)"
                  [rounded]="true">
                </p-tag>
              </td>
              <td>
                <span class="movimientos-count">
                  {{ getSafeValue(item?.totalMovimientos) }} movimientos
                </span>
                <div class="movimientos-detail">
                  <small class="entradas">↗ {{ getSafeValue(item?.totalEntradas) }} entradas</small>
                  <small class="salidas">↘ {{ getSafeValue(item?.totalSalidas) }} salidas</small>
                </div>
              </td>
              <td>
                <span class="fecha-ultimo">
                  {{ formatearFecha(item?.ultimoMovimiento) }}
                </span>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </p-tabpanel>

    <!-- Tab 2: Resumen por Producto -->
    <p-tabpanel value="productos">
      <div class="tab-content">
        <p-table 
          [value]="inventarioData.resumenPorProducto"
          [paginator]="true"
          [rows]="15"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} productos"
          styleClass="resumen-table"
          [scrollable]="true"
          scrollHeight="400px">

          <ng-template pTemplate="header">
            <tr>
              <th>Código</th>
              <th>Producto</th>
              <th>Stock Total</th>
              <th>Bodegas</th>
              <th>Último Movimiento</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-producto>
            <tr>
              <td>
                <span class="codigo-producto">{{ producto?.producto?.codigo || 'N/A' }}</span>
              </td>
              <td>
                <div class="producto-info">
                  <strong>{{ producto?.producto?.descripcion || 'Sin descripción' }}</strong>
                  <small class="unidad">{{ producto?.producto?.unidadMedida || 'N/A' }}</small>
                </div>
              </td>
              <td>
                <p-tag 
                  [value]="formatNumber(producto?.stockTotal)"
                  [severity]="getStockSeverity(producto?.stockTotal)"
                  [rounded]="true"
                  class="stock-total">
                </p-tag>
              </td>
              <td>
                <span class="bodegas-count">{{ getSafeValue(producto?.bodegas) }} bodegas</span>
              </td>
              <td>
                <span class="fecha-ultimo">
                  {{ formatearFecha(producto?.ultimoMovimiento) }}
                </span>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </p-tabpanel>

    <!-- Tab 3: Resumen por Bodega -->
    <p-tabpanel value="bodegas">
      <div class="bodegas-grid">
        @for (bodega of inventarioData.resumenPorBodega; track bodega.bodega.id) {
          <div class="bodega-card">
            <div class="bodega-header">
              <h4>{{ bodega.bodega.nombre }}</h4>
              @if (bodega.bodega.ubicacion) {
                <p class="ubicacion">
                  <i class="pi pi-map-marker"></i>
                  {{ bodega.bodega.ubicacion }}
                </p>
              }
            </div>
            <div class="bodega-stats">
              <div class="stat">
                <span class="value">{{ getSafeValue(bodega.totalProductos) }}</span>
                <span class="label">Productos</span>
              </div>
              <div class="stat">
                <span class="value">{{ formatNumber(bodega.stockTotal) }}</span>
                <span class="label">Stock Total</span>
              </div>
            </div>
          </div>
        }
      </div>
    </p-tabpanel>
  </p-tabpanels>
</p-tabs>
  </div>

  <!-- Footer -->
  <ng-template pTemplate="footer">
    <div class="inventario-footer">
      <small class="ultima-actualizacion">
        Última actualización: {{ formatearFecha(inventarioData?.estadisticas?.ultimaActualizacion) }}
      </small>
      <div class="footer-actions">
        <p-button 
          icon="pi pi-refresh"
          label="Actualizar"
          severity="secondary"
          (onClick)="loadInventarioGeneral()">
        </p-button>
        
        <p-button 
          icon="pi pi-times"
          label="Cerrar"
          severity="secondary"
          (onClick)="closeInventarioDialog()">
        </p-button>
      </div>
    </div>
  </ng-template>
</p-dialog>

<!-- Dialog de Edición de Movimiento -->
<p-dialog 
  header="Editar Movimiento" 
  [modal]="true" 
  [closable]="true" 
  [draggable]="false" 
  [resizable]="false"
  [style]="{ width: '500px' }"
  [(visible)]="displayEditDialog">
  
  <div class="edit-dialog-content" *ngIf="movimientoToEdit">
    
    <!-- Información del movimiento (solo lectura) -->
    <div class="movimiento-info">
      <h4>Información del Movimiento</h4>
      <div class="info-grid">
        <div class="info-item">
          <label>Tipo:</label>
          <p-tag 
            [value]="movimientoToEdit.tipo === 'entrada' ? 'Entrada' : 'Salida'"
            [severity]="getSeverityForTipo(movimientoToEdit.tipo)"
            [icon]="movimientoToEdit.tipo === 'entrada' ? 'pi pi-arrow-up' : 'pi pi-arrow-down'">
          </p-tag>
        </div>
        
        <div class="info-item">
          <label>Producto:</label>
          <span>{{ movimientoToEdit.producto.descripcion }}</span>
        </div>
        
        <div class="info-item">
          <label>Bodega:</label>
          <span>{{ movimientoToEdit.bodega.nombre }}</span>
        </div>
        
        <div class="info-item">
          <label>Fecha:</label>
          <span>{{ formatDate(movimientoToEdit.fecha) }}</span>
        </div>
        
        <div class="info-item" *ngIf="movimientoToEdit.cliente">
          <label>Cliente:</label>
          <span>{{ movimientoToEdit.cliente.nombre }}</span>
        </div>
      </div>
    </div>
    
    <!-- Formulario de edición -->
    <form [formGroup]="editForm" *ngIf="editForm" class="edit-form">
      
      <!-- Cantidad -->
      <div class="field">
        <label for="edit-cantidad">
          <i class="pi pi-calculator"></i>
          Cantidad *
        </label>
        <p-inputNumber
          id="edit-cantidad"
          formControlName="cantidad"
          mode="decimal"
          [minFractionDigits]="2"
          [maxFractionDigits]="2"
          [min]="0.01"
          [step]="1"
          placeholder="0.00"
          styleClass="w-full"
          [class.ng-invalid]="isEditFieldInvalid('cantidad')">
        </p-inputNumber>
        <small class="p-error" *ngIf="isEditFieldInvalid('cantidad')">
          <i class="pi pi-exclamation-triangle"></i>
          {{ getEditFieldError('cantidad') }}
        </small>
      </div>
      
      <!-- Observaciones -->
      <div class="field">
        <label for="edit-observacion">
          <i class="pi pi-file-edit"></i>
          Observaciones
        </label>
        <textarea
          id="edit-observacion"
          pInputTextarea
          formControlName="observacion"
          rows="3"
          placeholder="Observaciones del movimiento (opcional)"
          class="w-full">
        </textarea>
      </div>
      
    </form>
  </div>
  
  <!-- Footer del dialog -->
  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        severity="secondary"
        [outlined]="true"
        (onClick)="cancelEdit()">
      </p-button>
      
      <p-button 
        label="Guardar Cambios" 
        icon="pi pi-check" 
        severity="primary"
        [disabled]="!isEditFormValid()"
        (onClick)="saveEditedMovimiento()">
      </p-button>
    </div>
  </ng-template>
</p-dialog>

<!-- Dialog de División de Producto -->
<p-dialog 
  header="División de Producto" 
  [modal]="true" 
  [closable]="true" 
  [draggable]="false" 
  [resizable]="false"
  [style]="{ width: '800px', maxHeight: '90vh' }"
  [(visible)]="displayDivisionDialog">
  
  <div class="division-dialog-content">
    
    <!-- Información explicativa -->
    <div class="division-info">
      <div class="info-header">
        <i class="pi pi-info-circle"></i>
        <h4>División de Producto</h4>
      </div>
      <p>Esta función permite dividir un producto existente en múltiples productos diferentes. 
      Por ejemplo: dividir 10 vacas en 5 unidades de carne y 5 unidades de hueso.</p>
    </div>
    
    <!-- Formulario de división -->
    <form [formGroup]="divisionForm" *ngIf="divisionForm" class="division-form">
      
      <!-- Producto Origen -->
      <div class="origen-section">
        <h5><i class="pi pi-box"></i> Producto Origen</h5>
        
        <div class="form-grid">
          <!-- Producto -->
          <div class="form-field">
            <label for="division-producto">
              Producto <span class="required">*</span>
            </label>
            <p-select 
              id="division-producto"
              formControlName="productoOrigenId"
              [options]="productos"
              placeholder="Seleccionar producto a dividir"
              optionLabel="descripcion"
              optionValue="id"
              [filter]="true"
              filterBy="descripcion,codigo"
              (onChange)="onProductoOrigenChange()"
              [class.ng-invalid]="isDivisionFieldInvalid('productoOrigenId')">
              <ng-template pTemplate="selectedItem" let-producto>
                <span *ngIf="producto">{{ producto.codigo }} - {{ producto.descripcion }}</span>
              </ng-template>
              <ng-template pTemplate="item" let-producto>
                <div class="producto-option">
                  <span class="codigo">{{ producto.codigo }}</span>
                  <span class="descripcion">{{ producto.descripcion }}</span>
                </div>
              </ng-template>
            </p-select>
            <small 
              class="p-error" 
              *ngIf="isDivisionFieldInvalid('productoOrigenId')">
              Producto origen es requerido
            </small>
          </div>
          
          <!-- Bodega -->
          <div class="form-field">
            <label for="division-bodega">
              Bodega <span class="required">*</span>
            </label>
            <p-select 
              id="division-bodega"
              formControlName="bodegaId"
              [options]="bodegas"
              placeholder="Seleccionar bodega"
              optionLabel="nombre"
              optionValue="id"
              [class.ng-invalid]="isDivisionFieldInvalid('bodegaId')">
            </p-select>
            <small 
              class="p-error" 
              *ngIf="isDivisionFieldInvalid('bodegaId')">
              Bodega es requerida
            </small>
          </div>
          
          <!-- Cantidad Total -->
          <div class="form-field">
            <label for="division-cantidad">
              Cantidad Total <span class="required">*</span>
            </label>
            <p-inputNumber 
              id="division-cantidad"
              formControlName="cantidadTotal"
              mode="decimal"
              [minFractionDigits]="0"
              [maxFractionDigits]="2"
              [min]="0.01"
              placeholder="0.00"
              (onInput)="onCantidadTotalChange()"
              [class.ng-invalid]="isDivisionFieldInvalid('cantidadTotal')">
            </p-inputNumber>
            <small 
              class="p-error" 
              *ngIf="isDivisionFieldInvalid('cantidadTotal')">
              Cantidad debe ser mayor a 0
            </small>
          </div>
        </div>
      </div>
      
      <!-- Productos Destino -->
      <div class="destino-section">
        <div class="destino-header">
          <h5><i class="pi pi-arrow-right"></i> Productos Destino</h5>
          <p-button 
            icon="pi pi-plus" 
            label="Agregar Producto"
            severity="secondary"
            size="small"
            (onClick)="agregarProductoDestino()">
          </p-button>
        </div>
        
        <div class="productos-destino" *ngIf="productosDestino.length > 0">
          <div 
            *ngFor="let item of productosDestino; let i = index; trackBy: trackByIndex" 
            class="producto-destino-item">
            
            <div class="item-header">
              <span class="item-number">{{ i + 1 }}</span>
              <h6>Producto Destino {{ i + 1 }}</h6>
              <p-button 
                icon="pi pi-trash" 
                severity="danger" 
                size="small"
                [outlined]="true"
                (onClick)="removerProductoDestino(i)"
                pTooltip="Eliminar producto destino">
              </p-button>
            </div>
            
            <div class="item-form">
              <div class="form-field">
                <label>Producto</label>
                <p-select 
                  [(ngModel)]="item.productoId"
                  [options]="productos"
                  placeholder="Seleccionar producto"
                  optionLabel="descripcion"
                  optionValue="id"
                  [filter]="true"
                  filterBy="descripcion,codigo"
                  [ngModelOptions]="{standalone: true}"
                  [class.ng-invalid]="!item.productoId">
                  <ng-template pTemplate="selectedItem" let-producto>
                    <span *ngIf="producto">{{ producto.codigo }} - {{ producto.descripcion }}</span>
                  </ng-template>
                  <ng-template pTemplate="item" let-producto>
                    <div class="producto-option">
                      <span class="codigo">{{ producto.codigo }}</span>
                      <span class="descripcion">{{ producto.descripcion }}</span>
                    </div>
                  </ng-template>
                </p-select>
              </div>
              
              <div class="form-field">
                <label>Cantidad</label>
                <p-inputNumber 
                  [(ngModel)]="item.cantidad"
                  mode="decimal"
                  [minFractionDigits]="0"
                  [maxFractionDigits]="2"
                  [min]="0.01"
                  placeholder="0.00"
                  (onInput)="onCantidadDestinoChange()"
                  [ngModelOptions]="{standalone: true}"
                  [class.ng-invalid]="!item.cantidad || item.cantidad <= 0">
                </p-inputNumber>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Mensaje si no hay productos destino -->
        <div *ngIf="productosDestino.length === 0" class="no-productos-destino">
          <i class="pi pi-info-circle"></i>
          <p>No hay productos destino agregados. Haga clic en "Agregar Producto" para comenzar.</p>
        </div>
      </div>
      
      <!-- Resumen -->
      <div class="division-resumen" *ngIf="productosDestino.length > 0">
        <h5><i class="pi pi-calculator"></i> Resumen</h5>
        <div class="resumen-grid">
          <div class="resumen-item">
            <label>Cantidad Total:</label>
            <span class="value">{{ getCantidadTotal() }}</span>
          </div>
          <div class="resumen-item">
            <label>Cantidad Asignada:</label>
            <span class="value">{{ getCantidadAsignada() }}</span>
          </div>
          <div class="resumen-item">
            <label>Diferencia:</label>
            <span class="value" [class]="getDiferenciaClass()">{{ getDiferencia() }}</span>
          </div>
        </div>
        
        <!-- Alertas -->
        <div *ngIf="getDiferencia() !== 0" class="division-alert">
          <i class="pi pi-exclamation-triangle"></i>
          <span *ngIf="getDiferencia() > 0" class="alert-text">
            Faltan {{ getDiferencia() }} unidades por asignar
          </span>
          <span *ngIf="getDiferencia() < 0" class="alert-text">
            Hay {{ Math.abs(getDiferencia()) }} unidades de más asignadas
          </span>
        </div>
      </div>
      
      <!-- Observaciones -->
      <div class="form-field">
        <label for="division-observacion">Observaciones</label>
        <textarea 
          id="division-observacion"
          pTextarea 
          formControlName="observacion"
          placeholder="Notas sobre la división del producto..."
          rows="3"
          [autoResize]="true">
        </textarea>
      </div>
      
    </form>
  </div>
  
  <!-- Footer del dialog -->
  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        severity="secondary"
        [outlined]="true"
        (onClick)="cancelDivision()">
      </p-button>
      
      <p-button 
        label="Procesar División" 
        icon="pi pi-check" 
        severity="warn"
        [disabled]="!isDivisionFormValid()"
        (onClick)="procesarDivision()">
      </p-button>
    </div>
  </ng-template>
</p-dialog>

<!-- Dialog de Combinación de Productos -->
<p-dialog 
  header="Combinación de Productos (Crear Combo)" 
  [modal]="true" 
  [closable]="true" 
  [draggable]="false" 
  [resizable]="false"
  [style]="{ width: '800px', maxHeight: '90vh' }"
  [(visible)]="displayCombinacionDialog">
  
  <div class="combinacion-dialog-content">
    
    <!-- Información explicativa -->
    <div class="combinacion-info">
      <div class="info-header">
        <i class="pi pi-info-circle"></i>
        <h4>Combinación de Productos</h4>
      </div>
      <p>Esta función permite combinar varios productos individuales para crear un combo. 
      Por ejemplo: Leche (2) + Mortadela (3) + Atún (4) = Combo Favorito 1 (9 unidades total).</p>
    </div>
    
    <!-- Formulario de combinación -->
    <form [formGroup]="combinacionForm" *ngIf="combinacionForm" class="combinacion-form">
      
      <!-- Productos Origen (Ingredientes) -->
      <div class="ingredientes-section">
        <div class="ingredientes-header">
          <h5><i class="pi pi-minus-circle"></i> Productos Ingredientes (Egresos)</h5>
          <p-button 
            icon="pi pi-plus" 
            label="Agregar Ingrediente"
            severity="secondary"
            size="small"
            (onClick)="agregarIngrediente()">
          </p-button>
        </div>
        
        <div class="ingredientes-lista" *ngIf="ingredientes.length > 0">
          <div 
            *ngFor="let item of ingredientes; let i = index; trackBy: trackByIndex" 
            class="ingrediente-item">
            
            <div class="item-header">
              <span class="item-number">{{ i + 1 }}</span>
              <h6>Ingrediente {{ i + 1 }}</h6>
              <p-button 
                icon="pi pi-trash" 
                severity="danger" 
                size="small"
                [outlined]="true"
                (onClick)="removerIngrediente(i)"
                pTooltip="Eliminar ingrediente">
              </p-button>
            </div>
            
            <div class="item-form">
              <div class="form-field">
                <label>Producto</label>
                <p-select 
                  [(ngModel)]="item.productoId"
                  [options]="productos"
                  placeholder="Seleccionar producto"
                  optionLabel="descripcion"
                  optionValue="id"
                  [filter]="true"
                  filterBy="descripcion,codigo"
                  [ngModelOptions]="{standalone: true}"
                  (onChange)="onIngredienteChange()"
                  [class.ng-invalid]="!item.productoId">
                  <ng-template pTemplate="selectedItem" let-producto>
                    <span *ngIf="producto">{{ producto.codigo }} - {{ producto.descripcion }}</span>
                  </ng-template>
                  <ng-template pTemplate="item" let-producto>
                    <div class="producto-option">
                      <span class="codigo">{{ producto.codigo }}</span>
                      <span class="descripcion">{{ producto.descripcion }}</span>
                    </div>
                  </ng-template>
                </p-select>
              </div>
              
              <div class="form-field">
                <label>Cantidad</label>
                <p-inputNumber 
                  [(ngModel)]="item.cantidad"
                  mode="decimal"
                  [minFractionDigits]="0"
                  [maxFractionDigits]="2"
                  [min]="0.01"
                  placeholder="0.00"
                  (onInput)="onIngredienteChange()"
                  [ngModelOptions]="{standalone: true}"
                  [class.ng-invalid]="!item.cantidad || item.cantidad <= 0">
                </p-inputNumber>
                <small class="cantidad-type egreso">Egreso (-{{ item.cantidad || 0 }})</small>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Mensaje si no hay ingredientes -->
        <div *ngIf="ingredientes.length === 0" class="no-ingredientes">
          <i class="pi pi-info-circle"></i>
          <p>No hay ingredientes agregados. Haga clic en "Agregar Ingrediente" para comenzar.</p>
        </div>
      </div>
      
      <!-- Producto Combo (Destino) -->
      <div class="combo-section">
        <h5><i class="pi pi-plus-circle"></i> Producto Combo (Ingreso)</h5>
        
        <div class="form-grid">
          <!-- Producto Combo -->
          <div class="form-field">
            <label for="combo-producto">
              Producto Combo <span class="required">*</span>
            </label>
            <p-select 
              id="combo-producto"
              formControlName="productoComboId"
              [options]="productos"
              placeholder="Seleccionar producto combo"
              optionLabel="descripcion"
              optionValue="id"
              [filter]="true"
              filterBy="descripcion,codigo"
              [class.ng-invalid]="isCombinacionFieldInvalid('productoComboId')">
              <ng-template pTemplate="selectedItem" let-producto>
                <span *ngIf="producto">{{ producto.codigo }} - {{ producto.descripcion }}</span>
              </ng-template>
              <ng-template pTemplate="item" let-producto>
                <div class="producto-option">
                  <span class="codigo">{{ producto.codigo }}</span>
                  <span class="descripcion">{{ producto.descripcion }}</span>
                </div>
              </ng-template>
            </p-select>
            <small 
              class="p-error" 
              *ngIf="isCombinacionFieldInvalid('productoComboId')">
              Producto combo es requerido
            </small>
          </div>
          
          <!-- Bodega -->
          <div class="form-field">
            <label for="combo-bodega">
              Bodega <span class="required">*</span>
            </label>
            <p-select 
              id="combo-bodega"
              formControlName="bodegaId"
              [options]="bodegas"
              placeholder="Seleccionar bodega"
              optionLabel="nombre"
              optionValue="id"
              [class.ng-invalid]="isCombinacionFieldInvalid('bodegaId')">
            </p-select>
            <small 
              class="p-error" 
              *ngIf="isCombinacionFieldInvalid('bodegaId')">
              Bodega es requerida
            </small>
          </div>
          
          <!-- Cantidad Total (calculada automáticamente) -->
          <div class="form-field">
            <label>Cantidad Total del Combo</label>
            <div class="cantidad-calculada">
              <span class="valor-calculado">{{ getCantidadTotalIngredientes() }}</span>
              <small class="cantidad-type ingreso">Ingreso (+{{ getCantidadTotalIngredientes() }})</small>
            </div>
            <small class="p-help">Se calcula automáticamente sumando todos los ingredientes</small>
          </div>
        </div>
      </div>
      
      <!-- Resumen de Movimientos -->
      <div class="combinacion-resumen" *ngIf="ingredientes.length > 0">
        <h5><i class="pi pi-list"></i> Resumen de Movimientos</h5>
        
        <!-- Egresos -->
        <div class="resumen-seccion">
          <h6><i class="pi pi-arrow-down"></i> Egresos (Salidas)</h6>
          <div class="movimientos-lista">
            <div *ngFor="let item of ingredientes" class="movimiento-item egreso">
              <span class="producto-info">
                {{ getProductoNombre(item.productoId) }}
              </span>
              <span class="cantidad">-{{ item.cantidad || 0 }}</span>
            </div>
          </div>
        </div>
        
        <!-- Ingreso -->
        <div class="resumen-seccion">
          <h6><i class="pi pi-arrow-up"></i> Ingreso (Entrada)</h6>
          <div class="movimientos-lista">
            <div class="movimiento-item ingreso">
              <span class="producto-info">
                {{ getProductoNombre(combinacionForm.get('productoComboId')?.value) || 'Seleccionar combo...' }}
              </span>
              <span class="cantidad">+{{ getCantidadTotalIngredientes() }}</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Observaciones -->
      <div class="form-field">
        <label for="combinacion-observacion">Observaciones</label>
        <textarea 
          id="combinacion-observacion"
          pTextarea 
          formControlName="observacion"
          placeholder="Notas sobre la creación del combo..."
          rows="3"
          [autoResize]="true">
        </textarea>
      </div>
      
    </form>
  </div>
  
  <!-- Footer del dialog -->
  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        severity="secondary"
        [outlined]="true"
        (onClick)="cancelCombinacion()">
      </p-button>
      
      <p-button 
        label="Crear Combo" 
        icon="pi pi-check" 
        severity="help"
        [disabled]="!isCombinacionFormValid()"
        (onClick)="procesarCombinacion()">
      </p-button>
    </div>
  </ng-template>
</p-dialog>